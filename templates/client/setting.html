<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>V10 자동매매 봇 상세설정</title>
    <style>
        body { background: #f5f8fe; font-family: 'Noto Sans KR', sans-serif;}
        .container {
            background: #fff;
            padding:36px 28px 32px 28px;
            margin:48px auto;
            border-radius:16px;
            max-width:430px;
            box-shadow:0 8px 32px rgba(50,110,180,0.10), 0 2px 7px rgba(60,90,120,0.06);
        }
        .big-title {color:#2386ff;text-align:center;margin-bottom:22px;font-size:1.5rem;font-weight:800;}
        .flex-row {display:flex;align-items:center;gap:8px; margin-bottom:13px;}
        .dropdown, .input {padding:8px 10px; border-radius:7px; border:1.2px solid #dbe6fa; font-size:1rem;}
        .input {width:86px;}
        .dropdown {min-width:100px;}
        .usdt {color:#21af78;font-weight:700;padding:0 8px;}
        table {width:100%;border-collapse:collapse;margin:18px 0 22px 0;}
        th, td {border:1.1px solid #e3eefa; padding:7px 4px; text-align:center;font-size:1.05rem;}
        th {background:#eaf4ff;font-weight:700;}
        .btn-row {display:flex;gap:14px; margin-bottom:16px;}
        .btn {
            flex:1;
            padding:13px 0;
            border:none;
            border-radius:8px;
            background:linear-gradient(90deg,#2386ff,#39c2ff);
            color:#fff;
            font-size:1.05rem;
            font-weight:700;
            cursor:pointer;
            box-shadow:0 2px 8px #dbebfa77;
            transition: background 0.18s;
        }
        .btn:hover {background:linear-gradient(90deg,#196fd1,#2386ff);}
        .miniinput {width:56px;padding:6px;}
        .check {margin-right:8px;}
        .bot {margin-top:16px;}
        .setting-main-row {display:flex;align-items:center;justify-content:space-between;margin-bottom:13px;}
        .setting-main-row .dropdown {min-width:115px;}
        /* 아래 추가: 하단 배치 및 중앙 정렬 */
        .center-row {display:flex;justify-content:center;align-items:center;gap:22px;margin-bottom:10px;}
        .center-checkbox-row {display:flex;justify-content:center;align-items:center;gap:18px;margin-bottom:16px;}
        .center-btn-row {display:flex;justify-content:center;}
        .coin-estimate {font-size: 0.65rem !important; color: #2386ff; font-weight: normal;}
    </style>
</head>
<body>
    <div class="container">
        <div class="big-title">V10 자동매매 봇 상세설정</div>
        <form method="post" id="settingsForm">
            <input type="hidden" name="row_count" value="{{ row_count }}">
            <div class="setting-main-row">
                <div>
                    <span>거래종목:</span>
                    <select class="dropdown" name="symbol">
                        <option value="BTCUSDT" {% if settings.symbol == 'BTCUSDT' %}selected{% endif %}>BTCUSDT</option>
                        <option value="ETHUSDT" {% if settings.symbol == 'ETHUSDT' %}selected{% endif %}>ETHUSDT</option>
                    </select>
                </div>
                <span class="usdt">지갑잔고 : <span id="balance-value">{% if real_balance is not none %}{{ real_balance }}{% else %}불러오기 실패{% endif %}</span> USDT</span>
            </div>
            <div class="flex-row">
                <span>마진모드:</span>
                <select class="dropdown" name="margin_mode">
                    <option {% if settings.margin_mode == '교차' %}selected{% endif %}>교차</option>
                    <option {% if settings.margin_mode == '격리' %}selected{% endif %}>격리</option>
                </select>
                <span>진입방향:</span>
                <select class="dropdown" name="side">
                    <option {% if settings.side == '롱(Long)' %}selected{% endif %}>롱(Long)</option>
                    <option {% if settings.side == '숏(Short)' %}selected{% endif %}>숏(Short)</option>
                </select>
            </div>
            <div class="flex-row">
                <span>주문방식:</span>
                <select class="dropdown" disabled style="background-color: #f0f0f0;">
                    <option selected>시장가</option>
                </select>
                <input type="hidden" name="order_type" value="시장가">
                <span>레버리지:</span>
                <input class="input" type="number" name="leverage" value="{{settings.leverage or 15.0}}" min="1" max="100">
                <span style="color:#1976d2;font-weight:600;">x</span>
            </div>
            <table>
                <tr>
                    <th>No</th>
                    <th>추가진입간격(%)</th>
                    <th>진입금액(USDT)</th>
                    <th>예상BTC</th>
                </tr>
                {% for i in range(1, row_count+1) %}
                <tr>
                    <td>{{"%02d"|format(i)}}</td>
                    <td><input class="miniinput" type="number" name="dca_gap_{{i}}" value="{{settings.dca_levels[i-1]['gap'] if settings.dca_levels and i-1 < settings.dca_levels|length else '0.0'}}" step="0.1"></td>
                    <td><input class="miniinput amount-input" type="number" name="dca_amount_{{i}}" value="{{settings.dca_levels[i-1]['amount'] if settings.dca_levels and i-1 < settings.dca_levels|length else '0.0'}}" data-row="{{i}}"></td>
                    <td><span class="coin-estimate" id="estimate_{{i}}">-</span></td>
                </tr>
                {% endfor %}
            </table>
            <div class="btn-row">
                <button name="action" value="add" type="submit" class="btn" style="background:#39c2ff;">추가</button>
                <button name="action" value="remove" type="submit" class="btn" style="background:#d9e7fb;color:#2386ff;">삭제</button>
            </div>
            <!-- ↓↓↓ 익절/손절/체크박스/설정확인 버튼 부분 수정 ↓↓↓ -->
            <div class="center-row">
                <span>익절: <input class="miniinput" type="number" name="take_profit" value="{{settings.take_profit or 0.3}}" step="0.1"></span>
                <span>손절: <input class="miniinput" type="number" name="stop_loss" value="{{settings.stop_loss or 1.0}}" step="0.1"></span>
            </div>
            <div class="center-row" style="margin-top: 15px;">
                <span>반복실행: 
                    <label style="margin-left: 10px;"><input type="radio" name="repeat_enabled" value="1" {% if settings.repeat_enabled %}checked{% endif %}> O</label>
                    <label style="margin-left: 10px;"><input type="radio" name="repeat_enabled" value="0" {% if not settings.repeat_enabled %}checked{% endif %}> X</label>
                </span>
                <span style="margin-left: 30px;">손절시봇정지: 
                    <label style="margin-left: 10px;"><input type="radio" name="stop_on_loss" value="1" {% if settings.stop_on_loss %}checked{% endif %}> O</label>
                    <label style="margin-left: 10px;"><input type="radio" name="stop_on_loss" value="0" {% if not settings.stop_on_loss %}checked{% endif %}> X</label>
                </span>
            </div>
            <div class="center-btn-row" style="gap: 15px;">
                <button class="btn bot" type="submit" name="action" value="save" onclick="return validateForm()" style="width:170px; font-size:1.09rem;">설정저장</button>
                <button class="btn bot" type="button" onclick="window.location.href='/dashboard'" style="width:170px; font-size:1.09rem; background: #6c757d;">대시보드 이동</button>
            </div>
        </form>
    </div>

<script>
// Cache busting version
const VERSION = new Date().getTime();
console.log('Setting page loaded - Version:', VERSION);
let currentPrice = 0;
let currentSymbol = 'BTCUSDT';

// 계약 크기 정의
const contractSizes = {
  'BTCUSDT': 0.001,
  'ETHUSDT': 0.01
};

// 폼 검증 함수
function validateForm() {
    const rows = document.querySelectorAll('tbody tr');
    let hasValidAmount = false;
    let invalidRows = [];
    
    rows.forEach((row, index) => {
        const gapInput = row.querySelector('input[name^="dca_gap_"]');
        const amountInput = row.querySelector('input[name^="dca_amount_"]');
        
        if (gapInput && amountInput) {
            const gap = parseFloat(gapInput.value) || 0;
            const amount = parseFloat(amountInput.value) || 0;
            
            // 진입간격이 0 이상이고 진입금액이 0보다 큰 경우만 유효
            if (gap >= 0 && amount > 0) {
                hasValidAmount = true;
            } else if (amount === 0 && gap >= 0) {
                // 진입금액이 0인 행 기록
                invalidRows.push(index + 1);
            }
        }
    });
    
    if (!hasValidAmount) {
        alert('진입금액은 0보다 커야 합니다.\n최소 하나 이상의 유효한 진입금액을 입력해주세요.');
        return false;
    }
    
    if (invalidRows.length > 0) {
        alert(`${invalidRows.join(', ')}번째 행의 진입금액이 0입니다.\n0인 행은 저장되지 않습니다.`);
    }
    
    // 익절/손절 값 검증
    const takeProfit = parseFloat(document.querySelector('input[name="take_profit"]').value);
    const stopLoss = parseFloat(document.querySelector('input[name="stop_loss"]').value);
    
    if (takeProfit <= 0) {
        alert('익절 값은 0보다 커야 합니다.');
        return false;
    }
    
    if (stopLoss <= 0) {
        alert('손절 값은 0보다 커야 합니다.');
        return false;
    }
    
    return true;
}

// 잔고 업데이트 함수
async function updateBalance() {
  try {
    const response = await fetch('/get_balance', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      const balanceElement = document.getElementById('balance-value');
      if (balanceElement) {
        balanceElement.textContent = data.balance !== null ? data.balance.toFixed(2) : '불러오기 실패';
      }
    }
  } catch (error) {
    console.error('잔고 업데이트 오류:', error);
  }
}

// 가격 업데이트 함수
async function updatePrice() {
  try {
    const symbolSelect = document.querySelector('select[name="symbol"]');
    currentSymbol = symbolSelect ? symbolSelect.value : 'BTCUSDT';
    
    const response = await fetch(`/get_price?symbol=${currentSymbol}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.price) {
        currentPrice = data.price;
        updateAllEstimates();
      }
    }
  } catch (error) {
    console.error('가격 업데이트 오류:', error);
  }
}

// 모든 예상 BTC 업데이트
function updateAllEstimates() {
  if (!currentPrice || currentPrice <= 0) {
    console.log('Price not yet loaded, skipping estimate update');
    return;
  }
  
  const leverage = parseFloat(document.querySelector('input[name="leverage"]').value) || 1;
  console.log('Updating estimates with leverage:', leverage, 'and price:', currentPrice);
  
  // 모든 행을 순회하여 업데이트
  const table = document.querySelector("table");
  const rows = Array.from(table.querySelectorAll("tr")).filter(r => !r.querySelector("th"));
  
  rows.forEach((row, index) => {
    const rowNum = index + 1;
    const amountInput = row.querySelector(`input[name="dca_amount_${rowNum}"]`);
    const estimateElement = row.querySelector(`#estimate_${rowNum}`);
    
    if (amountInput && estimateElement) {
      const amount = parseFloat(amountInput.value) || 0;
      
      if (amount > 0) {
        // 사용설명서 계산방법: 진입금액USDT / (현재가/레버리지)
        // = 진입금액USDT * 레버리지 / 현재가
        const coinAmount = (amount * leverage) / currentPrice;
        
        // 모든 코인 6자리로 통일
        let displayAmount = coinAmount.toFixed(6);
        
        estimateElement.textContent = `${displayAmount} ${currentSymbol.replace('USDT', '')}`;
        estimateElement.style.color = '#2386ff';
        estimateElement.style.fontSize = '0.65rem';  // Decreased font size
        estimateElement.style.fontWeight = 'normal';
      } else {
        estimateElement.textContent = '-';
      }
    }
  });
}

// 초기 로드
updateBalance();
updatePrice();

// 5초마다 업데이트
setInterval(updateBalance, 5000);
setInterval(updatePrice, 5000);

// 페이지 로드 후 예상 BTC 업데이트
setTimeout(() => {
  updateAllEstimates();
}, 1000);

document.addEventListener("DOMContentLoaded", () => {
  // DOM 로드 후 가격 다시 로드하고 예상 BTC 업데이트
  setTimeout(() => {
    updatePrice();
  }, 500);
  const table = document.querySelector("table");
  const addBtn = document.querySelector("button[value='add']");
  const removeBtn = document.querySelector("button[value='remove']");
  let rowCountInput = document.querySelector("input[name='row_count']");
  
  // 심볼 변경 시 가격 업데이트
  const symbolSelect = document.querySelector('select[name="symbol"]');
  if (symbolSelect) {
    symbolSelect.addEventListener('change', updatePrice);
  }
  
  // 레버리지 변경 시 예상 계약수 업데이트
  const leverageInput = document.querySelector('input[name="leverage"]');
  if (leverageInput) {
    leverageInput.addEventListener('input', function() {
      if(this.value > 100) this.value = 100;
      if(this.value < 1) this.value = 1;
      updateAllEstimates();
    });
  }
  
  // 금액 입력 시 예상 계약수 업데이트
  document.addEventListener('input', (e) => {
    if (e.target.classList.contains('amount-input')) {
      updateAllEstimates();
    }
  });

  // 클릭한 행을 선택 표시
  table.addEventListener("click", (e) => {
    const tr = e.target.closest("tr");
    if (!tr || tr.querySelector("th")) return; // 헤더 제외
    
    // input이나 button 클릭시에는 선택하지 않음
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') {
      return;
    }
    
    // 토글 선택
    tr.classList.toggle("selected");
    // 스타일 (간단하게)
    if (tr.classList.contains("selected")) {
      tr.style.background = "#ffeeba";
    } else {
      tr.style.background = "";
    }
  });

  // 추가: 마지막 번호 기준으로 새 행 추가
  addBtn.addEventListener("click", (e) => {
    e.preventDefault(); // 서버 제출 막기
    const currentRows = Array.from(table.querySelectorAll("tr")).filter(r => !r.querySelector("th"));
    const newIndex = currentRows.length + 1;

    // 새 tr 생성
    const tr = document.createElement("tr");

    const tdNo = document.createElement("td");
    tdNo.textContent = String(newIndex).padStart(2, "0");

    const tdGap = document.createElement("td");
    const inputGap = document.createElement("input");
    inputGap.type = "number";
    inputGap.name = `dca_gap_${newIndex}`;
    inputGap.step = "0.1";
    inputGap.value = "0.0";
    inputGap.className = "miniinput";
    tdGap.appendChild(inputGap);

    const tdAmt = document.createElement("td");
    const inputAmt = document.createElement("input");
    inputAmt.type = "number";
    inputAmt.name = `dca_amount_${newIndex}`;
    inputAmt.step = "0.1";
    inputAmt.value = "0.0";
    inputAmt.className = "miniinput amount-input";
    inputAmt.dataset.row = newIndex;
    tdAmt.appendChild(inputAmt);

    const tdEstimate = document.createElement("td");
    const spanEstimate = document.createElement("span");
    spanEstimate.className = "coin-estimate";
    spanEstimate.id = `estimate_${newIndex}`;
    spanEstimate.textContent = "-";
    tdEstimate.appendChild(spanEstimate);

    tr.appendChild(tdNo);
    tr.appendChild(tdGap);
    tr.appendChild(tdAmt);
    tr.appendChild(tdEstimate);

    // tbody가 없으면 그냥 table에 append (템플릿에 tbody 없으므로)
    table.appendChild(tr);
    
    // 새로 추가된 행의 이벤트 리스너 등록
    inputAmt.addEventListener('input', updateAllEstimates);
    
    // 현재 값으로 예상 계약수 즉시 업데이트
    updateAllEstimates();

    // row_count 갱신
    if (rowCountInput) {
      rowCountInput.value = newIndex;
    }
  });

  // 삭제: 선택된 행이 있으면 그 행들 삭제, 없으면 마지막 행 삭제
  removeBtn.addEventListener("click", (e) => {
    e.preventDefault();
    const rows = Array.from(table.querySelectorAll("tr")).filter(r => !r.querySelector("th"));
    const selected = rows.filter(r => r.classList.contains("selected"));

    let targetRows;
    if (selected.length > 0) {
      targetRows = selected;
    } else if (rows.length > 0) {
      targetRows = [rows[rows.length -1]]; // 마지막 행
    } else {
      return; // 삭제할 게 없음
    }

    targetRows.forEach(r => r.remove());

    // 번호 재정렬
    const remaining = Array.from(table.querySelectorAll("tr")).filter(r => !r.querySelector("th"));
    remaining.forEach((tr, idx) => {
      const noCell = tr.children[0];
      noCell.textContent = String(idx + 1).padStart(2, "0");
      // 이름도 갱신: dca_gap_{n}, dca_amount_{n}
      const gapInput = tr.querySelector("input[name^='dca_gap_']");
      const amtInput = tr.querySelector("input[name^='dca_amount_']");
      const estimateSpan = tr.querySelector("span[id^='estimate_']");
      
      if (gapInput) gapInput.name = `dca_gap_${idx+1}`;
      if (amtInput) {
        amtInput.name = `dca_amount_${idx+1}`;
        amtInput.dataset.row = idx+1;
      }
      if (estimateSpan) estimateSpan.id = `estimate_${idx+1}`;
    });

    // row_count 갱신
    if (rowCountInput) {
      rowCountInput.value = remaining.length;
    }
    
    // 행 삭제 후 모든 예상 계약수 업데이트
    updateAllEstimates();
  });
  
  // 설정 저장 버튼 처리
  const settingsForm = document.getElementById('settingsForm');
  const saveBtn = document.querySelector('button[value="save"]');
  
  if (saveBtn) {
    saveBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      
      // 폼 데이터 수집
      const formData = new FormData(settingsForm);
      formData.set('action', 'save');
      
      try {
        const response = await fetch('/setting', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(result.message);
        } else {
          alert('설정 저장에 실패했습니다.');
        }
      } catch (error) {
        console.error('Error saving settings:', error);
        alert('설정 저장 중 오류가 발생했습니다.');
      }
    });
  }
});
</script>
</body>
</html>
